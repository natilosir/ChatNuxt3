import{_ as Z,r as d,i as S,j as P,c as v,o as u,a as l,f as j,v as O,k as ee,l as te,g as $,d as se,F as A,m as I,p as T,q as ae,e as oe,n as le,s as ne,x as re,h as ie,y as ce,b as z,z as ue,A as de,B as ve,C as he,D as fe,E as pe,t as R}from"./CI--yoU-.js";import{p as E,u as _e}from"./DSqpYqpb.js";import{t as D,r as W,h as L,M as me,s as ye}from"./DmZ9LRu2.js";import{c as ge}from"./BFgTw9Sf.js";const xe={class:"message-input violet-gradient-theme"},ke=["onKeydown","placeholder"],Ce={__name:"MessageInput",setup(N){const n=d(""),i=d(null),w=d(null),_=d(!1);S(L,r=>{w.value=r},{immediate:!0});const h=async()=>{if(i.value.focus(),!n.value.trim()||_.value)return;_.value=!0;const r=`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,o=n.value;n.value="";const y={id:r,text:o,sender:"me",created_at:new Date().toLocaleTimeString("fa-IR"),status:null};D.value=y;try{const f=await E("send",{receiver:w.value,text:o});if(!(f!=null&&f.success))throw new Error("Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");W.value={id:f.id,text:o,sender:f.sender||"me",created_at:f.created_at,status:0},M()}catch(f){console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…:",f),D.value={...y,status:2},s()}finally{_.value=!1}},m=P(()=>{const o=/[\u0600-\u06FF\s]/.test(n.value)||!n.value;return{direction:o?"rtl":"ltr",textAlign:o?"right":"left"}}),k=P(()=>m.value.direction==="rtl"?"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ØªÙˆ Ø¨Ù†ÙˆÛŒØ³... ğŸŒ¸":"Type your sweet message... ğŸŒ¸"),C=()=>{i.value&&(i.value.style.height="auto",i.value.style.height=`${Math.min(i.value.scrollHeight,120)}px`)},b=r=>{r.shiftKey?(n.value+=`
`,C()):h()},M=()=>{const r=new Audio("/assets/sound_out.wav");r.volume=.99,r.play().catch(o=>console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§:",o))},s=()=>{const r=new Audio("/assets/error.mp3");r.volume=.99,r.play().catch(o=>console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§:",o))};return S(n,r=>{!r&&i.value&&(i.value.style.height="auto")}),(r,o)=>(u(),v(A,null,[o[2]||(o[2]=l("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0, shrink-to-fit=no"},null,-1)),l("div",xe,[j(l("textarea",{"onUpdate:modelValue":o[0]||(o[0]=y=>n.value=y),onKeydown:te($(b,["prevent"]),["enter"]),ref_key:"textarea",ref:i,style:ee(m.value),placeholder:k.value,onInput:C,rows:"1",class:"violet-gradient-input",wrap:"soft"},null,44,ke),[[O,n.value]]),l("button",{onClick:h,class:"violet-gradient-button"},o[1]||(o[1]=[l("span",{class:"flower-effect"},"Ø§Ø±Ø³Ø§Ù„",-1),se(),l("span",{class:"small-flower"},"ğŸŒ¸",-1)]))])],64))}},Ie=Z(Ce,[["__scopeId","data-v-c309c796"]]),Se={key:0,class:"edit-modal"},we={class:"modal-content"},be={class:"modal-actions"},Ee={__name:"EditMessageModal",setup(N){const n=d(null),i=d(""),w=async()=>{n.value&&(await E("edit",{id:n.value.id,text:i.value}),n.value=null,i.value="",await loadMessages())};return(_,h)=>T(n)?(u(),v("div",Se,[l("div",we,[h[2]||(h[2]=l("h3",null,"ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…",-1)),j(l("textarea",{"onUpdate:modelValue":h[0]||(h[0]=m=>ae(i)?i.value=m:null)},null,512),[[O,T(i)]]),l("div",be,[l("button",{onClick:w},"Ø°Ø®ÛŒØ±Ù‡"),l("button",{onClick:h[1]||(h[1]=(...m)=>_.cancelEdit&&_.cancelEdit(...m))},"Ø§Ù†ØµØ±Ø§Ù")])])])):I("",!0)}},Me={key:1,class:"chat-room"},$e={key:0,class:"message-actions"},Be=["onClick"],Ve=["onClick"],Ae={class:"message-content"},De={class:"message-text"},Le={class:"message-footer"},Ne={class:"message-time"},He={key:0,class:"message-status"},Ue={key:0},qe={key:1},Fe={key:2},Ke={key:3,class:"error"},Pe={key:2,class:"load"},Oe={__name:"[_hash]",async setup(N){let n,i;([n,i]=oe(()=>ge()),n=await n,i(),n).isLoggedIn||le("/login"),ne("chat");const _=re(),h=d(null),m=d(!1),k=_.params._hash,C=d(null),b=d(""),M=d([]),s=d([]),r=d(""),o=d(null);let y=null;const f=d(k);let B=!1;L.value=k,S(D,e=>{var c;if(!(e!=null&&e.id)||typeof e.id!="string"){console.error("Invalid temp message format",e);return}(c=s.value)!=null&&c.chats||(s.value={chats:[]});const a=s.value.chats.findIndex(t=>t.id===e.id);a!==-1?s.value.chats[a]={...e}:s.value.chats.push({...e}),g()},{deep:!0}),S(W,e=>{var c;if(!e)return;(c=s.value)!=null&&c.chats||(s.value={chats:[]});const a=s.value.chats.findIndex(t=>!(t!=null&&t.id)||!(t!=null&&t.text)||!(e!=null&&e.text)||typeof t.id!="string"?!1:t.text===e.text&&t.id.startsWith("temp-"));a!==-1?s.value.chats[a]={...e}:s.value.chats.push({...e}),g()},{deep:!0}),_e("last_hash").value=k,S(()=>{var e;return(e=s.value)==null?void 0:e.chats},(e,a)=>{e&&e.length!==((a==null?void 0:a.length)||0)&&g()},{deep:!0}),S(()=>_.params._hash,e=>{f.value=e,L.value=e,H(),q()});const V=e=>e.sender!==k||e.sender==="me",X=()=>{C.value=null,b.value=""},G=e=>{C.value=e,b.value=e.text},H=async()=>{try{const e=await E("AllChats",{receiver:f.value});s.value=e,me.value=e,g("auto")}catch(e){console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú†Øª:",e)}},J=async()=>{var e,a,c;if(!(B||!f.value))try{B=!0;const t=await E("load",{receiver:f.value});if(Array.isArray(t))if(t.length===0)(e=s.value)!=null&&e.chats&&s.value.chats.forEach(p=>{p.status=1});else{if(t[0]==="X")return;const p=new Audio("/assets/sound_in.wav");p.volume=.7,p.play().catch(x=>console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§:",x)),(a=s.value)!=null&&a.chats||(s.value={chats:[]}),t.forEach(x=>{s.value.chats.some(Y=>Y.id===x.id)||s.value.chats.push(x)}),g("auto")}else t!=null&&t.chats&&((c=s.value)!=null&&c.chats?t.chats.forEach(p=>{s.value.chats.some(K=>K.id===p.id)||s.value.chats.push(p)}):s.value=t)}catch(t){console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯:",t)}finally{B=!1}},g=(e="smooth")=>{const a=e==="auto"?"auto":"smooth";he(()=>{var t;const c=(t=h.value)==null?void 0:t.querySelector(".messages");c&&c.scrollTo({top:c.scrollHeight,behavior:a})})},U=()=>{var a;const e=(a=h.value)==null?void 0:a.querySelector(".messages");if(e){const{scrollTop:c,scrollHeight:t,clientHeight:p}=e;m.value=t-(c+p)>350}},Q=async e=>{await E("delete",{id:e}),M.value=M.value.filter(a=>a.id!==e)},q=()=>{F(),y=ye(async()=>{await J()},4e3)},F=()=>{y&&(clearInterval(y),y=null)};return ie(async()=>{await H(),g("auto"),q(),o.value&&o.value.addEventListener("scroll",U)}),ce(()=>{F(),o.value&&o.value.removeEventListener("scroll",U)}),(e,a)=>{const c=fe;return u(),v(A,null,[z(c,{keepalive:""}),l("div",{class:"chat-room dark-theme",ref_key:"chatRoomRef",ref:h},[m.value?(u(),v("button",{key:0,onClick:$(g,["stop"]),class:"scroll-to-bottom-btn",title:"Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†"},"â†“")):I("",!0),s.value.chats?(u(),v("div",Me,[l("div",{class:"messages",ref_key:"messagesContainer",ref:o},[(u(!0),v(A,null,de(s.value.chats,(t,p)=>(u(),v("div",{key:p,class:pe(["message",V(t)?"sent":"received"])},[V(t)&&t.status===1?(u(),v("div",$e,[l("button",{onClick:$(x=>G(t),["stop"]),class:"action-btn"},"âœï¸",8,Be),l("button",{onClick:$(x=>Q(t.id),["stop"]),class:"action-btn"},"ğŸ—‘ï¸",8,Ve)])):I("",!0),l("div",Ae,[l("p",De,R(t.text),1),l("div",Le,[l("span",Ne,R(t.created_at),1),V(t)?(u(),v("span",He,[t.status===null?(u(),v("span",Ue,"ğŸ•“")):t.status===0?(u(),v("span",qe,"âœ”")):t.status===1?(u(),v("span",Fe,"âœ“âœ“")):t.status===2?(u(),v("span",Ke,"âœ˜")):I("",!0)])):I("",!0)])])],2))),128))],512)])):(u(),v("div",Pe,a[1]||(a[1]=[ve('<div class="circle"></div><div class="circle"></div><div class="circle"></div><div class="circle"></div><div class="circle"></div>',5)]))),z(Ie,{modelValue:r.value,"onUpdate:modelValue":a[0]||(a[0]=t=>r.value=t),onSend:e.sendMessage},null,8,["modelValue","onSend"]),C.value?(u(),ue(Ee,{key:3,message:b.value,onSave:e.updateMessage,onCancel:X},null,8,["message","onSave"])):I("",!0)],512)],64)}}};export{Oe as default};
